---
title: "440 Case Study I"
author: "Jake Epstein, Daniel Spottiswood, Michael Tan, Sahil Patel, Man-Lin Hsiao"
date: "9/3/2019"
output:
  pdf_document:
    dev: png
    fig_height: 2.5
    fig_width: 4
  html_document: default
---

## Set Up, Load, Clean Data
```{r}
## load packages
library(dplyr)
library(ggplot2)
library(MASS)
library(gridExtra)

## read in data
births = read.csv("data/Yr1116Birth.csv", na.strings = "9999")
deaths = read.csv("data/Yr1116Death.csv")
 
## rewrite NAs
births$SEX[which(births$SEX == 9)] = NA
births$CIGPN[which(births$CIGPN == 99)] = NA
births$CIGFN[which(births$CIGFN == 99)] = NA
births$CIGSN[which(births$CIGSN == 99)] = NA
births$CIGLN[which(births$CIGLN == 99)] = NA
births$PARITY[which(births$PARITY == 99)] = NA
births$PLUR[which(births$PLUR == 99)] = NA
births$GEST[which(births$GEST == 99)] = NA
births$MAGE[which(births$MAGE == 99)] = NA

select = dplyr::select
```


## Exploratory Data Analysis

### Birthweight
```{r}
summary(births$BWTG)
sd(births$BWTG, na.rm = TRUE)
ggplot(births, aes(x= BWTG))+
  geom_histogram(binwidth=100, colour="black", 
                          aes(y=..density.., fill=..count..), position = "stack") + 
  stat_function(fun = dnorm, color = "red", args = list(mean = mean(births$BWTG, na.rm = TRUE), sd = sd(births$BWTG, na.rm = TRUE))) +
  theme_minimal()
```
Birthweight is close to normally distrubted, with a slight left skew, centered around ~3300g with a standard deviation of 600g. There appear to be no large outliers in terms of birthweight. 430 birth weights are missing. We see that the left tail is much larger than we would expect in a normal distribution

### Smoking
```{r}
births = births %>% mutate(
  CIGPN_binary = CIGPN>0,
  CIGFN_binary = CIGFN>0,
  CIGSN_binary = CIGSN>0,
  CIGLN_binary = CIGLN>0
)

births = births %>%
  mutate(total_smoked = CIGFN+CIGSN+CIGLN) %>%
  mutate(smoked_during = total_smoked >0)

mean(births$smoked_during,na.rm=TRUE)

mean(births$CIGPN_binary, na.rm = TRUE)
mean(births$CIGFN_binar, na.rm = TRUE)
mean(births$CIGSN_binary,na.rm = TRUE)
mean(births$CIGLN_binary, na.rm = TRUE)

ggplot(births %>% filter(smoked_during), aes(x = total_smoked))+
  geom_histogram() +
  theme_minimal()

mean(births %>% filter(smoked_during) %>% select(total_smoked) %>% unlist())

ggplot(births, aes(x= smoked_during, y = BWTG)) +
  geom_boxplot()+
  theme_minimal()

lm_smoking_v_non = lm(data=births, BWTG~smoked_during)
summary(lm_smoking_v_non)


births = births %>%
  mutate(smoking_type = ifelse(smoked_during, 
      ifelse(CIGPN_binary, "before and during", "during only"),
      ifelse(CIGPN_binary, "before only", "none"))) %>%
  mutate(smoking_type = relevel(as.factor(smoking_type), ref = 4))


ggplot(births, aes(x= smoking_type, y = BWTG)) +
  geom_boxplot()+
  theme_minimal()

lm_smoking = lm(data=births, BWTG~smoking_type)
summary(lm_smoking)

```
Around 13% of women smoked in the three months leading up to pregnancy and around 10% of women at any point during their pregnancy. Among those who did smoke during pregnance, the average number of cigarettes smoked during pregnancy was 23. The birthweight of children of smokers was significantly lower than that of the children of nonsmokers, with an average difference of 231 grams. There is also a significant relationship between birthweight and smoking before pregnancy, even for those who did not smoke during pregnancy.


### Parity

```{r}
# Check the parity frequencies
summary(births$PARITY)
births$PARITY = as.numeric(births$PARITY)
births = births %>% 
  mutate(PARITY_truncated = ifelse(
    PARITY > 4, "5+", PARITY)
  )
  
births$PARITY = as.factor(births$PARITY)
ggplot(data = births, mapping = aes(x = PARITY, y = BWTG)) +
  geom_boxplot() + xlab("Parity") + ylab("Birth weight (g)") + 
  ggtitle("NC Births, 2011-2016") + theme_minimal()
ggplot(births, aes(x = PARITY)) +
  stat_count()+
  theme_minimal()

# Model without any change, significant up to the low teens
parity_reg = lm(BWTG ~ PARITY, births)
summary(parity_reg)

# Rerun EDA with truncated data
births$PARITY_truncated = as.factor(births$PARITY_truncated)
ggplot(births, aes(x = PARITY_truncated)) +
  stat_count() +
  theme_minimal()

ggplot(data = births, mapping = aes(x = PARITY_truncated, y = BWTG)) +
  geom_boxplot() + xlab("Parity Truncated") + ylab("Birth weight (g)") + 
  ggtitle("NC Births, 2011-2016") +
  theme_minimal()

parity_truncated_reg = lm(BWTG ~ PARITY_truncated, births)
summary(parity_truncated_reg)
```
Independent of other variables, we see a negative relationship between parity and birth weight past the first child. The frequency of parity decreases in an exponential fashion. A second variable was created that truncates parities of at least five to improve interprability and prevent overfitting. The quantity of missing data is relatively small.

### Plurality

```{r}
# Check the plurality frequencies
births$PLUR = as.numeric(births$PLUR)

births = births %>% 
  mutate(PLUR_truncated = ifelse(PLUR > 2, "3+", PLUR))

births$PLUR = as.factor(births$PLUR)
ggplot(data = births, mapping = aes(x = PLUR, y = BWTG)) +
  geom_boxplot() +
  xlab("Plurality") +
  ylab("Birth weight (g)") + 
  ggtitle("NC Births, 2011-2016") + 
  theme_minimal()

ggplot(births, aes(x = PLUR)) +
  stat_count() +
  theme_minimal()

plurality_reg = lm(BWTG ~ PLUR, births)
summary(plurality_reg)

births$PLUR_truncated = as.factor(births$PLUR_truncated)

ggplot(data = births, mapping = aes(x = PLUR_truncated, y = BWTG)) +
  geom_boxplot() + 
  xlab("Plurality Truncated") + 
  ylab("Birth weight (g)") + 
  ggtitle("NC Births, 2011-2016") + 
  theme_minimal()


ggplot(births, aes(x = PLUR_truncated)) +
  stat_count() + 
  theme_minimal()

plurality_reg_truncated = lm(BWTG ~ PLUR_truncated, births)
summary(plurality_reg_truncated)
```

We see a strong non linear negative relationship between plurality and birth weight. The frequency of pluralities above two is extremely small, and we again see a proportionally small amount of missing data. A second variable was created that truncates pluralities of at least three to improve interprability and prevent overfitting

### Gestation

```{r}

ggplot(data = births, mapping = aes(x = as.factor(GEST), y = BWTG)) +
  xlab("Gestation Period (weeks)") + 
  ylab("Birth weight (g)") + 
  geom_boxplot() +
  ggtitle("NC Births, 2011-2016") + 
  theme_minimal()


ggplot(births, aes(x = GEST)) +
  stat_count() + 
  theme_minimal()

gest_reg = lm(BWTG ~ GEST, births)
summary(gest_reg)
```
There appears to be a non linear positive relationship between gestation period and birth weight. The mean gestational period is approximately 38.5 weeks and the period with the highest median weight is 42 weeks. The frequency distribution is left skewed with the majority of babies having a gestational period between 38 and 40 weeks. There is some concern that more extreme gestational periods may lead to higher variance, and it should be noted that there is a chunk of data points with gestational periods of 17 to 21 weeks that have much higher than expected birth weights. There is an extreme outlier with gestational age of 83 weeks. Given that this data point was probably incorrectly recorded, we will exclude it from our analysis when building the model.

### Age of Mother

```{r}
ggplot(data = births, mapping = aes(x = MAGE, y = BWTG)) +
  xlab("Age of Mother (years)") + 
  ylab("Birth weight (g)") + 
  geom_point() +
  geom_smooth(method='lm', na.rm = TRUE) + 
  ggtitle("NC Births, 2011-2016") + 
  theme_minimal()


ggplot(births, aes(x = MAGE)) +
  geom_histogram(binwidth=1, colour="black", 
                          aes(y=..density.., fill=..count..), position = "stack") + 
  stat_function(fun = dnorm, color = "red", args = list(mean = mean(births$MAGE, na.rm = TRUE), sd = sd(births$MAGE, na.rm = TRUE))) +
  theme_minimal()

mage_reg = lm(BWTG ~ MAGE, births)
summary(mage_reg)
```
Mother's age seems to be fairly normally distributed with a mean of 27.8. There appears to be a positive relationship between the age of the mother and the birth weight. There is no evidence to suggest that the birth weight variance is not constant across the mother's age.

### Race of Mother

```{r}
births$MRACER = as.factor(births$MRACER)
ggplot(data = births, mapping = aes(x = MRACER, y = BWTG)) +
  xlab("Race of Mother") + 
  ylab("Birth weight (g)") + 
  geom_boxplot() +
  ggtitle("NC Births, 2011-2016") + 
  theme_minimal()

bw_race_avgs = births %>%
  group_by(MRACER) %>%
  summarize(mweight = mean(BWTG, na.rm = TRUE), freq_percent = n()/nrow(births))
bw_race_avgs

ggplot(births, aes(x = MRACER)) +
  stat_count() +
  theme_minimal()

mage_reg = lm(BWTG ~ MRACER, births)
summary(mage_reg)
```
0 - non-white,, 1 = white, 2 black, 3 indian, 8 other asian

There are significant differences between the average birth weights of mother's of different races. We see that mother's that self identified as white have the largest mean baby weight at 3.33 kg, while black mother's have the lowest mean baby weight at only 3.07 kg. 58 percent of mother's identify as white, 24 percent identify as black, 12 percent identify as non-white, and 3 percent identify as other asian.

### County / Socioeconomic Status
```{r}
#calculate infant mortality by county, to use as a proxy for socioconomic status
deaths_by_county = deaths %>%
  group_by(cores) %>%
  summarize(n_deaths = n()) %>%
  rename(CORES=cores)

births_by_county = births %>%
  group_by(CORES) %>%
  summarize(n_births = n())

infant_mortality = merge(deaths_by_county, births_by_county, by = "CORES") %>%
  mutate(mortality = n_deaths/n_births*100) %>% #note: mortality rate is as percentage
  select(-n_births, -n_deaths)

births = merge(births, infant_mortality, by = "CORES")

summary(births$mortality)

ggplot(births, aes(x= mortality))+
  geom_histogram() +
  xlab("Mortality Rate (%)")+
  theme_minimal() +
  ggtitle("Histogram of Infant Mortality Rate by County")

bwtg_vs_mortality = lm(data = births, BWTG~mortality)
summary(bwtg_vs_mortality)

ggplot(births, aes(x = mortality, y = BWTG))+
  geom_point() +
  geom_abline(slope = bwtg_vs_mortality$coefficients[[2]], intercept = bwtg_vs_mortality$coefficients[[1]])+
  theme_minimal()


```

We chose to use infant mortality rate of birth county as a proxy for socioeconomic status, calculated as number of deaths before the age of 1 divided by total number of births in a county. The median county in the data had a infant mortality rate of 0.7%, with the range of infant mortality rates in our dataset ranging from 0.12% to 1.76%. Infant mortality rate of birth county and birth weight appear to have a weak negative linear relationship, and in isolation, a 1 percentage point increase in infant mortality rate is associated with a 157g decrease in expected birth weight.


## Build Model

```{r}
births_excl = na.omit(births)
births_excl = births_excl[which(births_excl$GEST < 80), ]
births_excl = births_excl %>%
  mutate(GEST2 = GEST^2, GEST3 = GEST ^ 3, GEST4 = GEST^4)
model1 = lm(data = births_excl, BWTG ~ GEST + PARITY_truncated + PLUR_truncated + smoking_type + MAGE + MRACER + mortality, na.action = "na.exclude")
summary(model1)
plot(model1)
# plot(model1$fitted.values, model1$residuals)
plot(births_excl$GEST, model1$residuals)
plot(births_excl$PLUR_truncated, model1$residuals)
plot(births_excl$PARITY_truncated, model1$residuals)
plot(births_excl$smoking_type, model1$residuals)
plot(births_excl$MRACER, model1$residuals)
plot(births_excl$MAGE, model1$residuals)
```
The residuals vs fitted values and residuals vs gestational period plot slope downwards, indicating that there is a departure from linearity. More precisely, the linear model underpredicts when gestational period is below ~30 and overpredicts when gestational period is above ~30. A transformation may be helpful. The model may improve if a square term is added. There is a particularly high residual (in terms of absolute value) around 80 weeks of gestation, which is likely an outlier that has no reason to be there, as no humans can possibly gestate for 80 weeks (~1.54 years).

The residual graph for Plurality (truncated) has decreasing residuals (in terms of absolute value) as plurality increases. This makes sense, as birth weight should get smaller (and as a result range of birth weights should get tighter, leading to smaller absolute value residuals) as more babies share a womb and share nutrients -- More sharing will biologically cause them to come out smaller.

The residual graph for Parity (truncated) has pretty random residuals that are all around the same size for each group.

The residual graph for Smoking has higher residuals for no smoking than for smoking of any kind. This makes sense, as birth weight could biologically get smaller in the presence of smoking, as smoking can be damaging to the fetus and be detrimental to its growth and weight. This would lead to the range of birth weights of smoking mothers getting tighter, leading to smaller absolute value residuals.

The residual graph for Mother's race indicates that residuals are lower for for races 3, 4, 5, 6, and 7 and higher for the other races. This could be something to explore.

The residual graph for Mother's age is fairly random, with residuals getting a bit smaller near the beginning and end (<20 years old and >45 years old).



```{r}
model2 = lm(data = births_excl, BWTG ~ GEST + GEST2 + PARITY_truncated + PLUR_truncated + smoking_type + MAGE + MRACER + mortality, na.action = "na.exclude")
summary(model2)
plot(model2)
# plot(model2$fitted.values, model2$residuals)
plot(births_excl$GEST, model2$residuals)
plot(births_excl$PLUR_truncated, model2$residuals)
plot(births_excl$PARITY_truncated, model2$residuals)
plot(births_excl$smoking_type, model2$residuals)
plot(births_excl$MRACER, model2$residuals)
plot(births_excl$MAGE, model2$residuals)
```
The new model still displays the original downwards trend in the residual vs gestational period graph. Perhaps another transformation on GEST would be helpful -- a cubic term can be added. The other residuals plots also retain their trends from model 1.

```{r}
model3 = lm(data = births_excl, BWTG ~ GEST + GEST2 + GEST3 + PARITY_truncated + PLUR_truncated + smoking_type + MAGE + MRACER + mortality, na.action = "na.exclude")
summary(model3)
plot(model3)
# plot(model3$fitted.values, model3$residuals)
plot(births_excl$GEST, model3$residuals)
plot(births_excl$PLUR_truncated, model3$residuals)
plot(births_excl$PARITY_truncated, model3$residuals)
plot(births_excl$smoking_type, model3$residuals)
plot(births_excl$MRACER, model3$residuals)
plot(births_excl$MAGE, model3$residuals)
```
The residual vs gestational period shows a much more random pattern than before. It is worth investigating if adding a quartic term would help. The other residuals plots also retain their trends from model 1.

```{r}
model4 = lm(data = births_excl, BWTG ~ GEST + GEST2 + GEST3 + GEST4 + PARITY_truncated + PLUR_truncated + smoking_type + MAGE + MRACER + mortality, na.action = "na.exclude")
summary(model4)
plot(model4)
# plot(model4$fitted.values, model4$residuals)
plot(births_excl$GEST, model4$residuals)
plot(births_excl$PLUR_truncated, model4$residuals)
plot(births_excl$PARITY_truncated, model4$residuals)
plot(births_excl$smoking_type, model4$residuals)
plot(births_excl$MRACER, model4$residuals)
plot(births_excl$MAGE, model4$residuals)
```

The addition of the quartic term does not seem to help. The residual vs gestational period graph shows that residuals increase in absolute value as gestational period increases from 20 to 40 weeks. These residuals are much less random than that of model 3.

Model 3 looks like the best, but perhaps we can use robust regression to improve upon this the massive residual of the outlier point near 80 weeks of gestational age.

### Robust on Model 3

```{r}

robust1 <- rlm(data = births_excl, BWTG ~ GEST + GEST2 + GEST3 + PARITY_truncated + PLUR_truncated + smoking_type + MAGE + MRACER + mortality, na.action = "na.exclude")
summary(robust1)
plot(robust1)
# plot(robust1$fitted.values, robust1$residuals)
plot(births_excl$GEST, robust1$residuals)
plot(births_excl$PLUR_truncated, robust1$residuals)
plot(births_excl$PARITY_truncated, robust1$residuals)
plot(births_excl$smoking_type, robust1$residuals)
plot(births_excl$MRACER, robust1$residuals)
plot(births_excl$MAGE, robust1$residuals)

#Check weights
robust1_weights = data.frame(bwt = births_excl$BWTG, gest = births_excl$GEST,
 resid=robust1$resid, weight=robust1$w)
robust1_weights[order(robust1$w)[c(1:5, (length(robust1$w)-5):length(robust1$w))],]
```

#### Note: change below to indicate taking out outlier

Checking the weights, the outlier point at gest = 83 with the residual of 57619 has indeed been weighted down (with a weight of 0.0093). The weights of four other points with high residuals are also weighted down.

Looking at the residual plot for gestational period, the residuals look mostly random (ignoring the outlier point at gest = 83).

## Cross Validation
```{r}
#Create folds
births_cv<-births_excl[sample(nrow(births_excl)),]
folds<-cut(seq(1,nrow(births_cv)),breaks=10,labels=FALSE)
test_list<-list()
train_list<-list()
for(i in 1:10){
  test_indices<-which(folds==i,arr.ind=TRUE)
  births_test<-births_cv[test_indices,]
  test_list[[i]]<-births_test
  births_train<-births_cv[-test_indices,]
  train_list[[i]]<-births_train
}

#Train and test model1
model1_test_mse<-list()
for(i in 1:10){
  model1_train<-lm(data=train_list[[i]],BWTG~GEST+PARITY_truncated+PLUR_truncated+smoking_type+MAGE+MRACER+mortality,na.action="na.exclude")
  model1_test<-predict(model1_train,train_list[[i]])
  model1_test_mse[[i]]<-mean((train_list[[i]]$BWTG-model1_test)^2)
}
test_mse<-list(model1_test_mse)

#Train and test model2
model2_test_mse<-list()
for(i in 1:10){
  model2_train<-lm(data=train_list[[i]],BWTG~GEST+GEST2+PARITY_truncated+PLUR_truncated+smoking_type+MAGE+MRACER+mortality,na.action="na.exclude")
  model2_test<-predict(model2_train,train_list[[i]])
  model2_test_mse[[i]]<-mean((train_list[[i]]$BWTG-model2_test)^2)
}
test_mse<-append(test_mse,list(model2_test_mse))

#Train and test model3
model3_test_mse<-list()
for(i in 1:10){
  model3_train<-lm(data=train_list[[i]],BWTG~GEST+GEST2+GEST3+PARITY_truncated+PLUR_truncated+smoking_type+MAGE+MRACER+mortality,na.action="na.exclude")
  model3_test<-predict(model3_train,train_list[[i]])
  model3_test_mse[[i]]<-mean((train_list[[i]]$BWTG-model3_test)^2)
}
test_mse<-append(test_mse,list(model3_test_mse))

#Train and test model4
model4_test_mse<-list()
for(i in 1:10){
  model4_train<-lm(data=train_list[[i]],BWTG~GEST+GEST2+GEST3+GEST4+PARITY_truncated+PLUR_truncated+smoking_type+MAGE+MRACER+mortality,na.action="na.exclude")
  model4_test<-predict(model4_train,train_list[[i]])
  model4_test_mse[[i]]<-mean((train_list[[i]]$BWTG-model4_test)^2)
}
test_mse<-append(test_mse,list(model4_test_mse))

#Train and test robust1
robust1_test_mse<-list()
for(i in 1:10){
  robust1_train<-rlm(data=train_list[[i]],BWTG~GEST+GEST2+GEST3+PARITY_truncated+PLUR_truncated+smoking_type+MAGE+MRACER+mortality,na.action="na.exclude")
  robust1_test<-predict(robust1_train,train_list[[i]])
  robust1_test_mse[[i]]<-mean((train_list[[i]]$BWTG-robust1_test)^2)
}
test_mse<-append(test_mse,list(robust1_test_mse))

#Results
results_cv<-matrix(c(lapply(test_mse,mean)),ncol=5)
colnames(results_cv)<-c('model1','model2','model3','model4','robust1')
rownames(results_cv)<-c('Average MSE')
results<-as.table(results_cv)
results
```