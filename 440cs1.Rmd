---
title: "440 Case Study I"
author: "Jake Epstein, Daniel Spottiswood, Michael Tan, Sahil Patel, Man-Lin Hsiao"
date: "9/3/2019"
output:
  pdf_document: default
  html_document: default
---

## Set Up, Load, Clean Data
```{r}
## load packages
library(dplyr)
library(ggplot2)

## read in data
births = read.csv("data/Yr1116Birth.csv", na.strings = "9999")
deaths = read.csv("data/Yr1116Death.csv")
 
## rewrite NAs
births$SEX[which(births$SEX == 9)] = NA
births$CIGPN[which(births$CIGPN == 99)] = NA
births$CIGFN[which(births$CIGFN == 99)] = NA
births$CIGSN[which(births$CIGSN == 99)] = NA
births$CIGLN[which(births$CIGLN == 99)] = NA
births$PARITY[which(births$PARITY == 99)] = NA
births$PLUR[which(births$PLUR == 99)] = NA
births$GEST[which(births$GEST == 99)] = NA
births$MAGE[which(births$MAGE == 99)] = NA

```


## Exploratory Data Analysis

### Birthweight
```{r}
summary(births$BWTG)
sd(births$BWTG, na.rm = TRUE)
ggplot(births, aes(x= BWTG))+
  geom_histogram() +
  theme_minimal()
```
Birthweight is close to normally distrubted, with a slight left skew, centered around ~3300g with a standard deviation of 600g. There appear to be no large outliers in terms of birthweight. 430 birth weights are missing

### Smoking
```{r}
smoking_variables = c("CIGPN", "CIGFN", "CIGSN", "CIGLN")
births = births %>% mutate(
  CIGPN_binary = CIGPN>0,
  CIGFN_binary = CIGFN>0,
  CIGSN_binary = CIGSN>0,
  CIGLN_binary = CIGLN>0
)

births = births %>%
  mutate(total_smoked = CIGFN+CIGSN+CIGLN) %>%
  mutate(smoked_during = total_smoked >0)

mean(births$smoked_during,na.rm=TRUE)

mean(births$CIGPN_binary, na.rm = TRUE)
mean(births$CIGFN_binar, na.rm = TRUE)
mean(births$CIGSN_binary,na.rm = TRUE)
mean(births$CIGLN_binary, na.rm = TRUE)

ggplot(births %>% filter(smoked_during), aes(x = total_smoked))+
  geom_histogram(fill = "blue") +
  theme_minimal()

mean(births %>% filter(smoked_during) %>% select(total_smoked) %>% unlist())

ggplot(births, aes(x= smoked_during, y = BWTG)) +
  geom_boxplot()+
  theme_minimal()

lm_smoking_v_non = lm(data=births, BWTG~smoked_during)
summary(lm_smoking_v_non)


births = births %>%
  mutate(smoking_type = ifelse(smoked_during, 
      ifelse(CIGPN_binary, "before and during", "during only"),
      ifelse(CIGPN_binary, "before only", "none"))) %>%
  mutate(smoking_type = relevel(as.factor(smoking_type), ref = 4))


ggplot(births, aes(x= smoking_type, y = BWTG)) +
  geom_boxplot()+
  theme_minimal()

lm_smoking = lm(data=births, BWTG~smoking_type)
summary(lm_smoking)

```
Around 13% of women smoked in the three months leading up to pregnancy and around 10% of women at any point during their pregnancy. Among those who did smoke during pregnance, the average number of cigarettes smoked during pregnancy was 23. The birthweight of children of smokers was significantly lower than that of the children of nonsmokers, with an average difference of 231 grams. There is also a significant relationship between birthweight and smoking before pregnancy, even for those who did not smoke during pregnancy.


### Parity

```{r}
# Check the parity frequencies
births$PARITY = as.factor(births$PARITY)
par(mfrow=c(2,1))
ggplot(data = births, mapping = aes(x = PARITY, y = BWTG)) +
  geom_boxplot() + xlab("Parity") + ylab("Birth weight (g)") + 
  ggtitle("NC Births, 2011-2016") + theme_minimal()
ggplot(births, aes(x = PARITY)) +
        stat_count()

# Model without any change, significant up to the low teens
parity_reg = lm(BWTG ~ PARITY, births)
summary(parity_reg)

# Create variable 5+ and rerun EDA
births$PARITY_truncated = factor(births$PARITY, levels=c(levels(births$PARITY), "5+"))
births$PARITY_truncated[which(as.integer(births$PARITY_truncated) >= 5)] = "5+"
ggplot(births, aes(x = PARITY_truncated)) +
        stat_count()
ggplot(data = births, mapping = aes(x = PARITY_truncated, y = BWTG)) +
  geom_boxplot() + xlab("Parity Truncated") + ylab("Birth weight (g)") + 
  ggtitle("NC Births, 2011-2016")
parity_truncated_reg = lm(BWTG ~ PARITY, births)
summary(parity_truncated_reg)
```
Independent of other variables, we see a negative relationship between parity and birth weight past the first child. The frequency of parity decreases in an exponential fashion. A second variable was created that truncates parities of at least five to improve interprability and prevent overfitting. The quantity of missing data is relatively small.

### Plurality

```{r}
# Check the plurality frequencies
births$PLUR = as.factor(births$PLUR)
ggplot(data = births, mapping = aes(x = PLUR, y = BWTG)) +
  geom_boxplot() + xlab("Plurality") + ylab("Birth weight (g)") + 
  ggtitle("NC Births, 2011-2016") + theme_minimal()
ggplot(births, aes(x = PLUR)) +
        stat_count()

plurality_reg = lm(BWTG ~ PLUR, births)
summary(plurality_reg)
```

We see a strong non linear negative relationship between plurality and birth weight. The frequency of pluralities above two is extremely small, and we again see a proportionally small amount of missing data.

### Gestation

```{r}
births$GEST = as.factor(births$GEST)
ggplot(data = births, mapping = aes(x = GEST, y = BWTG)) +
  xlab("Gestation Period (weeks)") + 
  ylab("Birth weight (g)") + 
  geom_boxplot() +
  ggtitle("NC Births, 2011-2016") + 
  theme_minimal()


ggplot(births, aes(x = GEST)) +
        stat_count()

gest_reg = lm(BWTG ~ GEST, births)
summary(gest_reg)
```
There appears to be a non linear positive relationship between gestation period and birth weight. The mean gestational period is approximately 38.5 weeks and the period with the highest median weight is 42 weeks. The frequency distribution is left skewed with the majority of babies having a gestational period between 38 and 40 weeks. There is some concern that more extreme gestational periods may lead to higher variance, and it should be noted that there is a chunk of data points with gestational periods of 17 to 21 weeks that have much higher than expected birth weights.

### Age of Mother

```{r}
ggplot(data = births, mapping = aes(x = MAGE, y = BWTG)) +
  xlab("Age of Mother (years)") + 
  ylab("Birth weight (g)") + 
  geom_smooth(method='lm', na.rm = TRUE) + 
  geom_point() +
  ggtitle("NC Births, 2011-2016") + 
  theme_minimal()


ggplot(births, aes(x = MAGE)) +
        stat_count()

mage_reg = lm(BWTG ~ MAGE, births)
summary(mage_reg)
```
Mother's age seems to be fairly normally distributed with a mean of 27.8. There appears to be a positive relationship between the age of the mother and the birth weight. There is no evidence to suggest that the birth weight variance is not constant across the mother's age.

### Race of Mother

```{r}
births$MRACER = as.factor(births$MRACER)
ggplot(data = births, mapping = aes(x = MRACER, y = BWTG)) +
  xlab("Race of Mother") + 
  ylab("Birth weight (g)") + 
  geom_boxplot() +
  ggtitle("NC Births, 2011-2016") + 
  theme_minimal()

bw_race_avgs = births %>%
  group_by(MRACER) %>%
  summarize(mweight = mean(BWTG, na.rm = TRUE), freq_percent = n()/nrow(births))
bw_race_avgs

ggplot(births, aes(x = MRACER)) +
        stat_count()

mage_reg = lm(BWTG ~ MRACER, births)
summary(mage_reg)
```
0 - non-white,, 1 = white, 2 black, 3 indian, 8 other asian

There are significant differences between the average birth weights of mother's of different races. We see that mother's that self identified as white have the largest mean baby weight at 3.33 kg, while black mother's have the lowest mean baby weight at only 3.07 kg. 58 percent of mother's identify as white, 24 percent identify as black, 12 percent identify as non-white, and 3 percent identify as other asian.

### County / Socioeconomic Status
```{r}
#calculate infant mortality by county, to use as a proxy for socioconomic status
deaths_by_county = deaths %>%
  group_by(cores) %>%
  summarize(n_deaths = n()) %>%
  rename(CORES=cores)

births_by_county = births %>%
  group_by(CORES) %>%
  summarize(n_births = n())

infant_mortality = merge(deaths_by_county, births_by_county, by = "CORES") %>%
  mutate(mortality = n_deaths/n_births*100) %>% #note: mortality rate is as percentage
  select(-n_births, -n_deaths)

births = merge(births, infant_mortality, by = "CORES")

summary(births$mortality)

ggplot(births, aes(x= mortality))+
  geom_histogram(fill="blue") +
  xlab("Mortality Rate (%)")+
  theme_minimal() +
  ggtitle("Histogram of Infant Mortality Rate by County")

bwtg_vs_mortality = lm(data = births, BWTG~mortality)
summary(bwtg_vs_mortality)

ggplot(births, aes(x = mortality, y = BWTG))+
  geom_point() +
  geom_abline(slope = bwtg_vs_mortality$coefficients[[2]], intercept = bwtg_vs_mortality$coefficients[[1]])+
  theme_minimal()


```

We chose to use infant mortality rate of birth county as a proxy for socioeconomic status, calculated as number of deaths before the age of 1 divided by total number of births in a county. The median county in the data had a infant mortality rate of 0.7%, with the range of infant mortality rates in our dataset ranging from 0.12% to 1.76%. Infant mortality rate of birth county and birth weight appear to have a weak negative linear relationship, and a 1 percentage point increase in infant mortality rate is associated with a 157g decrease in expected birth weight.

